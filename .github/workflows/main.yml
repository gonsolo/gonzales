name: Build debug

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}:latest
      # We need to pass the token to pull the package if it is private, though public packages are fine.
      # For now, assuming public or that the image is public.
      # If the image is private, we'd need credentials.
      # credentials:
      #   username: ${{ github.actor }}
      #   password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      # Fix directory permissions for builder (since we mount the workspace)
      - name: Fix permissions
        run: |
          chown -R builder:builder .

      - name: Cache .build
        uses: actions/cache@v3
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') || hashFiles('Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Check Versions
        run: |
          swift --version
          swiftlint --version

      - name: Lint
        run: |
             # Find where swift-bin installed libraries. usually /usr/lib/swift/lib or /opt/swift/...
             # searching for libsourcekitdInProc.so
             SWIFT_LIB_PATH=$(find /usr -name libsourcekitdInProc.so | head -n 1 | xargs dirname)
             echo "Found Swift lib path: $SWIFT_LIB_PATH"
             export LD_LIBRARY_PATH=$SWIFT_LIB_PATH:$LD_LIBRARY_PATH
             swiftlint

      - name: Compile debug
        run: |
          mkdir -p .build
          make debug

      - name: Run tests
        run: swift test
